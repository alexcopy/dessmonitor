---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dessmonitor
  namespace: dess
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dessmonitor
  template:
    metadata:
      labels:
        app: dessmonitor
    spec:
      containers:
      - name: dessmonitor
        image: redcopy/dessmonitor:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 8084
        volumeMounts:
        - name: logs
          mountPath: /app/logs
        - name: cache
          mountPath: /app/app/cache
        - name: cfg
          mountPath: /app/config.json
          subPath: config.json
          readOnly: true
        - name: cfg
          mountPath: /app/devices.yaml
          subPath: devices.yaml
          readOnly: true

      volumes:
      - name: logs
        hostPath:
          path: /srv/dessmonitor/logs
          type: DirectoryOrCreate
      - name: cache
        hostPath:
          path: /srv/dessmonitor/cache
          type: DirectoryOrCreate
      - name: cfg
        hostPath:
          path: /srv/dessmonitor/configs
          type: DirectoryOrCreate

---
apiVersion: v1
kind: Service
metadata:
  name: dessmonitor
  namespace: dess
spec:
  selector:
    app: dessmonitor
  ports:
    # порт, на котором сервис будет слушать,
    # и на который будет рути́ть Ingress
  - name: http
    port: 8085
    targetPort: 8084
    protocol: TCP

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: dessmonitor-ingress
  namespace: dess
  annotations:
    kubernetes.io/ingress.class: traefik
    cert-manager.io/cluster-issuer: letsencrypt-prod
    # чтобы слушать и на 80 (web), и на 443 (websecure)
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
spec:
  ingressClassName: traefik

  # TLS для обоих доменов
  tls:
    - hosts:
        - dess.gpsbox.ru
      secretName: dessmonitor-tls

  rules:
    - host: dess.gpsbox.ru
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: dessmonitor
                port:
                  number: 8085
