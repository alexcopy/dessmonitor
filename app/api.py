import logging
import os
# dessmonitor/api.py
import time
import hashlib
import urllib.request
import urllib.parse
import json
from dataclasses import dataclass, asdict
from pathlib import Path
from typing import Optional, Union

from app.logger import loki_handler
from shared_state.shared_state import shared_state

_TOKEN_FILE = Path(
    os.getenv("MONITOR_TOKEN_PATH", "app/cache/dess_token.json")
)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@dataclass
class DeviceData:
    timestamp: Optional[str] = None
    working_state: Optional[str] = None
    battery_voltage: Optional[float] = None
    battery_capacity: Optional[float] = None
    battery_charging_current: Optional[float] = None
    battery_discharging_current: Optional[float] = None
    pv1_voltage: Optional[float] = None
    pv1_power: Optional[float] = None
    pv2_voltage: Optional[float] = None
    pv2_power: Optional[float] = None
    pv_total_power: Optional[float] = None
    output_voltage: Optional[float] = None
    output_power: Optional[float] = None            # Active power
    output_apparent_power: Optional[float] = None   # ‚¨ÖÔ∏è NEW (–¥–ª—è WEB)
    ac_input_voltage: Optional[float] = None
    ac_input_frequency: Optional[float] = None
    ac_output_load: Optional[float] = None
    battery_status: Optional[str] = None
    pv_status: Optional[str] = None
    mains_status: Optional[str] = None
    load_status: Optional[str] = None
    charger_priority: Optional[str] = None
    output_priority: Optional[str] = None

    def to_dict(self) -> dict:
        return asdict(self)  # type: ignore[arg-type]

    def summary(self) -> str:
        """–ö—Ä–∞—Å–∏–≤–æ–µ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–µ —Ä–µ–∑—é–º–µ –¥–ª—è inverter.log."""
        mode_icons = {
            "Line Mode": "‚ö° –°–µ—Ç—å",
            "Battery Mode": "üîã –ë–∞—Ç–∞—Ä–µ—è",
            "PV Mode": "‚òÄÔ∏è  –°–æ–ª–Ω–µ—á–Ω—ã–µ",
            "Power Saving Mode": "üí§ –≠–Ω–µ—Ä–≥–æ—Å–±–µ—Ä.",
            "Standby Mode": "‚è∏Ô∏è  –û–∂–∏–¥–∞–Ω–∏–µ",
            "Bypass Mode": "‚Ü™Ô∏è  Bypass",
            "Fault Mode": "‚ùå –û—à–∏–±–∫–∞",
            "Invert Mode": "üîã –ò–Ω–≤–µ—Ä—Ç–æ—Ä",
        }
        mode_txt = self.working_state or "‚Äî"
        mode_icon = mode_icons.get(mode_txt, f"‚ÑπÔ∏è {mode_txt}")

        # –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –º–æ—â–Ω–æ—Å—Ç–∏ ‚Äî –ø–æ–¥—Å—Ç–∞–≤–∏–º –∫–∞–∂—É—â—É—é—Å—è
        out_power = self.output_power if self.output_power is not None else self.output_apparent_power

        # ‚îÄ‚îÄ helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        def fmt(val, unit: str = "", width: int = 5, prec: int = 1):
            return f"{val:>{width}.{prec}f}{unit}" if val is not None else ""

        # ‚îÄ‚îÄ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        raw_lines = [
            "",  # –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞-–æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∑–∞–ø–∏—Å—è–º–∏
            f"‚îå‚îÄ {self.timestamp} ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ",
            f"‚îÇ –†–µ–∂–∏–º           : {mode_icon}",
            f"‚îÇ Battery         : {fmt(self.battery_voltage, ' V')}  "
            f"| {fmt(self.battery_capacity, ' %', width=3, prec=0)}",
            f"‚îÇ   Charge curr.  : {fmt(self.battery_charging_current, ' A')}",
            f"‚îÇ   Disch. curr.  : {fmt(self.battery_discharging_current, ' A')}",
            f"‚îÇ PV-1            : {fmt(self.pv1_voltage, ' V')}  "
            f"| {fmt(self.pv1_power, ' W', prec=0)}",
            f"‚îÇ PV-2            : {fmt(self.pv2_voltage, ' V')}  "
            f"| {fmt(self.pv2_power, ' W', prec=0)}",
            f"‚îÇ AC-in           : {fmt(self.ac_input_voltage, ' V')}",
            f"‚îÇ Output power    : {fmt(out_power, ' W', prec=0)}  "
            f"| Load {fmt(self.ac_output_load, ' %', width=3, prec=0)}",
            "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ",
        ]

        # ‚Äî —É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –ø–æ—Å–ª–µ ¬´: ¬ª –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å ‚Äî
        lines = []
        for ln in raw_lines:
            if ln.strip() == "":  # —è–≤–Ω–æ –ø—É—Å—Ç–∞—è
                lines.append(ln)
                continue
            if ln.endswith(":") or ln.rstrip().endswith(":"):  # –ø–æ–ª–µ None ‚Üí –ø—Ä–æ–ø—É—Å–∫
                continue
            lines.append(ln)

        return "\n".join(lines)


class TokenExpiredError(Exception):
    pass


class DessAPI:
    API_BASE = "https://api.dessmonitor.com/public/"  # https
    APP_ID = "com.demo.test"
    APP_VERSION = "3.6.2.1"
    APP_CLIENT = "android"

    TITLE_MAPPING = {
        # –æ–±—â–∏–µ
        "Timestamp": "timestamp",
        "Êó∂Èó¥Êà≥": "timestamp",

        "Working State": "working_state",

        "Battery Voltage": "battery_voltage",
        "ÁîµÊ±†ÁîµÂéã": "battery_voltage",
        "Battery Capacity": "battery_capacity",
        "Battery Charging Current": "battery_charging_current",
        "Battery Discharge Current": "battery_discharging_current",

        "PV1 Input Voltage": "pv1_voltage",
        "PV1 Input Power": "pv1_power",
        "PV2 input voltage": "pv2_voltage",
        "PV2 input power": "pv2_power",
        "PV total Power": "pv_total_power",
        "PV Total Power": "pv_total_power",  # –∏–Ω–æ–≥–¥–∞ –¥—Ä—É–≥–æ–π —Ä–µ–≥–∏—Å—Ç—Ä

        "Output Voltage": "output_voltage",
        "Output Active Power": "output_power",
        "Output Apparent Power": "output_apparent_power",  # ‚¨ÖÔ∏è NEW

        "AC Input Voltage": "ac_input_voltage",
        "AC Input Frequency": "ac_input_frequency",
        "AC Output Load": "ac_output_load",

        "Battery Status": "battery_status",
        "PV Status": "pv_status",
        "Mains Status": "mains_status",
        "Load Status": "load_status",
        "Charger Source Priority": "charger_priority",
        "Output Source Priority": "output_priority",
    }

    def __init__(self, config, logger):
        self.email = config.email
        self.password = config.password
        self.company_key = config.company_key
        self.pn = config.pn
        self.dev_code = config.dev_code
        self.dev_addr = config.dev_addr
        self.sn = config.sn
        self.logger = logger
        self.token: Optional[str] = None
        self.secret: Optional[str] = None
        self.token_expiry: Optional[float] = None
        self.token_acquired_time: Optional[float] = None
        self._load_cached_token()  # ‚Üê –ø–æ–ø—Ä–æ–±—É–µ–º

        if not self.token:  # –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∏–ª–∏ —Ç–æ–∫–µ–Ω –ø—Ä–æ—Ç—É—Ö
            try:
                self.authenticate()
            except Exception as auth_exc:
                self.logger.warning(f"[API] –ù–µ —É–¥–∞–ª–æ—Å—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {auth_exc}. –ë—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ–±-–∫—Ä–∞—É–ª–µ—Ä.")

        lh = loki_handler()
        if lh not in self.logger.handlers:
            self.logger.addHandler(lh)

        self.imp = logging.getLogger("IMPORTANT")

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ü–æ–¥–ø–∏—Å—å
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    def _sha1_hex(self, raw: Union[str, bytes]) -> str:
        """–ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è type-checker: –ø—Ä–∏–≤–æ–¥–∏–º –∫ bytes."""
        raw_bytes = raw.encode("utf-8") if isinstance(raw, str) else raw
        return hashlib.sha1(raw_bytes).hexdigest()

    def _generate_sign(self, param_str: str, use_password: bool = False):
        # –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –ø–æ–¥–ø–∏—Å–∏: –±–µ–∑ –≤–µ–¥—É—â–µ–≥–æ '&'
        if param_str.startswith("&"):
            param_str = param_str[1:]

        salt = str(int(time.time() * 1000))
        if use_password:
            pwd_hash = self._sha1_hex(self.password)
            raw = f"{salt}{pwd_hash}{param_str}"
        else:
            # self.secret/self.token —Ç–æ—á–Ω–æ —Å—Ç—Ä–æ–∫–∏ –∫ —ç—Ç–æ–º—É –º–æ–º–µ–Ω—Ç—É
            raw = f"{salt}{self.secret}{self.token}{param_str}"
        return self._sha1_hex(raw), salt

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # HTTP –∑–∞–ø—Ä–æ—Å
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    def _do_api_request(self, params: dict, need_auth: bool = True) -> dict:
        # 1) –∫–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å
        params = params.copy()

        # 2) —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è –≤ –∫–æ–Ω—Ü–µ
        params.update({
            "source": "1",
            "_app_client_": self.APP_CLIENT,
            "_app_id_": self.APP_ID,
            "_app_version_": self.APP_VERSION
        })

        # 3) query –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
        query_str = "&".join(
            f"{urllib.parse.quote_plus(str(k))}={urllib.parse.quote_plus(str(v))}"
            for k, v in params.items()
        )

        # 4) –ø–æ–¥–ø–∏—Å—å
        sign, salt = self._generate_sign(query_str, use_password=not need_auth)

        # 5) —Ñ–∏–Ω–∞–ª—å–Ω—ã–π URL
        url = (
            f"{self.API_BASE}?sign={sign}&salt={salt}"
            f"{f'&token={self.token}' if need_auth else ''}"
            f"&{query_str}"
        )

        self.logger.info(f"[API] –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å: {url}")

        try:
            print("The request URL >>>", url, "\n>>> ", end="", flush=True)
            with urllib.request.urlopen(url, timeout=120) as resp:
                raw_data = resp.read()
            data = json.loads(raw_data.decode("utf-8"))
            if data.get("err") != 0:
                desc = data.get("desc", "Unknown error")
                if "TOKEN" in desc or data.get("err") == 0x0002:
                    raise TokenExpiredError("–¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫")
                raise RuntimeError(f"–û—à–∏–±–∫–∞ API: {desc}")
            return data
        except TokenExpiredError:
            raise
        except Exception as e:
            self.logger.error("[API] request error: %s", e,
                              extra={"type": "dess_api", "evt": "error"})
            raise RuntimeError(f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {e}")

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    def authenticate(self) -> None:
        self.logger.info("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (authSource)...")
        # ‚¨áÔ∏è –û—Ç–ª–∞–¥–∫–∞
        self.logger.debug(f"[AUTH] Email: {self.email}")
        self.logger.debug(f"[AUTH] Company key: {self.company_key}")
        pwd_hash = self._sha1_hex(self.password)
        self.logger.debug(f"[AUTH] Password SHA1: {pwd_hash[:16]}...")


        params = {"action": "authSource", "usr": self.email, "company-key": self.company_key}
        result = self._do_api_request(params, need_auth=False)
        dat = result.get("dat", {})
        self.token = dat.get("token")
        self.secret = dat.get("secret")
        self.token_expiry = dat.get("expire")
        self.token_acquired_time = time.time()
        if not self.token or not self.secret:
            raise RuntimeError("–ù–µ –ø–æ–ª—É—á–µ–Ω—ã token/secret –æ—Ç authSource.")
        self.logger.info("–£—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–ª—É—á–µ–Ω token.")
        self._save_token()

    def refresh_token(self) -> None:
        self.logger.info("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ (updateToken)...")
        params = {"action": "updateToken"}
        result = self._do_api_request(params, need_auth=True)
        dat = result.get("dat", {})
        self.token = dat.get("token") or self.token
        self.secret = dat.get("secret") or self.secret
        self.token_expiry = dat.get("expire") or self.token_expiry
        self.token_acquired_time = time.time()
        self.logger.info("–¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω.")
        self._save_token()

    def should_refresh_token(self) -> bool:
        if self.token_expiry is None or self.token_acquired_time is None:
            return True
        return (time.time() - self.token_acquired_time) >= 0.9 * float(self.token_expiry)

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    def fetch_device_data(self) -> DeviceData:
        try:
            if self.should_refresh_token():
                try:
                    self.refresh_token()
                except TokenExpiredError:
                    self.authenticate()
                except Exception as auth_exc:
                    self.logger.info(f"[API] –æ—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: {auth_exc}. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é...")
                    self.authenticate()

            params = {
                "action": "queryDeviceLastData",
                "i18n": "en_US",
                "pn": self.pn,
                "devcode": self.dev_code,
                "devaddr": self.dev_addr,
                "sn": self.sn,
            }
            result = self._do_api_request(params, need_auth=True)
            dd = self._parse_device_data(result)

        except Exception as main_exc:
            self.logger.info(f"[API] –æ—Å–Ω–æ–≤–Ω–æ–π API —É–ø–∞–ª: {main_exc}. –ü—ã—Ç–∞–µ–º—Å—è –≤–µ–±-–∫—Ä–æ–ª–ª‚Ä¶")
            return self.fetch_device_data_fallback()

    def fetch_device_data_fallback(self) -> DeviceData:
        """
        –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: web-–∫—Ä–æ–ª–ª querySPDeviceLastData
        """
        action_str = (
            "&action=querySPDeviceLastData"
            f"&pn={urllib.parse.quote_plus(str(self.pn))}"
            f"&devcode={urllib.parse.quote_plus(str(self.dev_code))}"
            f"&devaddr={urllib.parse.quote_plus(str(self.dev_addr))}"
            f"&sn={urllib.parse.quote_plus(str(self.sn))}"
            "&i18n=en_US"
        )

        # –ø–æ–¥–ø–∏—Å—å –∏ salt (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è & —Å–¥–µ–ª–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ _generate_sign)
        sign, salt = self._generate_sign(action_str, use_password=False)

        url = (
            f"https://web.dessmonitor.com/public/"
            f"?sign={sign}&salt={salt}&token={self.token}&{action_str}"
        )
        self.logger.info(f"[WEB] –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å: {url}")

        try:
            with urllib.request.urlopen(url, timeout=20) as resp:
                raw = resp.read().decode("utf-8")
            payload = json.loads(raw)
        except Exception as e:
            self.logger.error(f"[WEB] –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {e}")
            raise RuntimeError(f"–í–µ–±-–∫—Ä–æ–ª–ª –Ω–µ —É–¥–∞–ª—Å—è: {e}")

        # ‚¨ÖÔ∏è –î–æ–±–∞–≤–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏
        if payload.get("err") != 0:
            self.logger.error(f"[WEB] API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: {payload.get('desc')}")
            raise RuntimeError(f"–í–µ–±-–∫—Ä–æ–ª–ª –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: {payload.get('desc')}")

        dat = payload.get("dat", {})
        dd = DeviceData(timestamp=dat.get("gts"))

        # —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –≤—Ä–µ–º—è –∏–∑ gts (–º—Å)
        gts = dat.get("gts")
        if gts:
            try:
                ts = time.localtime(int(gts) // 1000)
                dd.timestamp = time.strftime("%Y-%m-%d %H:%M:%S", ts)
            except Exception:
                pass

        # pars ‚Äî —Å–ª–æ–≤–∞—Ä—å –º–∞—Å—Å–∏–≤–æ–≤: gd_, sy_, pv_, bt_, bc_
        parsed_fields = []  # ‚¨ÖÔ∏è –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
        for section_name, section in dat.get("pars", {}).items():
            for item in section:
                title = item.get("par")
                val = item.get("val")
                field = self.TITLE_MAPPING.get(title)
                if not field:
                    continue

                if field in [
                    "timestamp", "working_state", "battery_status",
                    "pv_status", "mains_status", "load_status",
                    "charger_priority", "output_priority"
                ]:
                    setattr(dd, field, val)
                    parsed_fields.append(f"{field}={val}")
                else:
                    try:
                        float_val = float(val)
                        setattr(dd, field, float_val)
                        parsed_fields.append(f"{field}={float_val}")
                    except Exception as e:
                        self.logger.warning(f"[WEB] –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å {title}={val} –≤ float: {e}")
                        setattr(dd, field, None)

        self.logger.info(f"[WEB] –£—Å–ø–µ—à–Ω–æ —Å–ø–∞—Ä—Å–∏–ª–∏ {len(parsed_fields)} –ø–æ–ª–µ–π: {', '.join(parsed_fields[:5])}...")
        return dd

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ü–∞—Ä—Å–µ—Ä –æ—Ç–≤–µ—Ç–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ API
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    def _parse_device_data(self, data: dict) -> DeviceData:
        dd = DeviceData()
        for item in data.get("dat", []):
            title = item.get("title", "").strip()
            val = item.get("val", "").strip()
            field = self.TITLE_MAPPING.get(title)
            if field:
                if field in ["timestamp", "working_state", "battery_status",
                             "pv_status", "mains_status", "load_status",
                             "charger_priority", "output_priority"]:
                    setattr(dd, field, val)
                else:
                    try:
                        setattr(dd, field, float(val))
                    except ValueError:
                        setattr(dd, field, None)
        return dd

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ö–µ—à —Ç–æ–∫–µ–Ω–∞
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    def _load_cached_token(self):
        if not _TOKEN_FILE.exists():
            return
        try:
            data = json.loads(_TOKEN_FILE.read_text())
            # –Ω–µ–±–æ–ª—å—à–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ¬´–∂–∏–≤ –ª–∏¬ª (10% –±—É—Ñ–µ—Ä)
            if time.time() - data["acquired_at"] < 0.9 * data["expires_in"]:
                self.token = data["token"]
                self.secret = data["secret"]
                self.token_expiry = data["expires_in"]
                self.token_acquired_time = data["acquired_at"]
                self.logger.info("[API] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ token –∏–∑ –∫–µ—à–∞")
        except Exception as e:
            self.logger.error(f"[API] –Ω–µ —Å–º–æ–≥–ª–∏ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–µ—à token: {e}")

    def _save_token(self):
        try:
            _TOKEN_FILE.parent.mkdir(exist_ok=True)
            _TOKEN_FILE.write_text(json.dumps({
                "token": self.token,
                "secret": self.secret,
                "expires_in": self.token_expiry,
                "acquired_at": self.token_acquired_time
            }))
        except Exception as e:
            self.logger.error(f"[API] –Ω–µ —Å–º–æ–≥–ª–∏ –∑–∞–ø–∏—Å–∞—Ç—å –∫–µ—à token: {e}")
