name: Build & Deploy dessmonitor

on:
  push:
    branches: [ master ]
  workflow_dispatch:             

env:
  IMAGE_NAME: redcopy/dessmonitor

jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
    - name: ‚¨áÔ∏è  Checkout
      uses: actions/checkout@v4

    - name: üîß Set up QEMU (multi‚Äëarch, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      uses: docker/setup-qemu-action@v3

    - name: üîß Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: üîë Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: üì¶ Build & Push image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.IMAGE_NAME }}:latest
          ${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy:
    needs: build-push
    runs-on: ubuntu-latest
    steps:
    - name: ‚¨áÔ∏è  Checkout (–¥–ª—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤)
      uses: actions/checkout@v4

    - name: üîë Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: v1.29.0          # ‚âà –≤–µ—Ä—Å–∏—è k3s/k8s

    - name: üóÑÔ∏è  Write kubeconfig
      # KUBE_CONFIG ‚Äì base64‚Äëencoded –∏–ª–∏ plain kube‚Äëconfig,
      # —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Secrets –Ω–∞ GitHub.
      run: |
        echo "${KUBE_CONFIG}" > $HOME/.kube/config
      env:
        KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

    - name: üöÄ Deploy to k3s
      run: |
        # –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Å–≤–µ–∂–∏–π sha‚Äë—Ç–µ–≥ –≤–º–µ—Å—Ç–æ ¬´latest¬ª, —á—Ç–æ–±—ã k8s —Ç–æ—á–Ω–æ –ø–æ—Ç—è–Ω—É–ª –Ω–æ–≤—ã–π —Å–ª–æ–π
        IMAGE_TAG=${{ env.IMAGE_NAME }}:${{ github.sha }}
        # patch image –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ –Ω–∞ –ª–µ—Ç—É –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º
        sed "s|redcopy/dessmonitor:latest|${IMAGE_TAG}|g" k8s/dessmonitor-deploy.yaml | kubectl apply -f -
        kubectl apply -f k8s/dessmonitor-svc.yaml
        kubectl rollout status deploy/dessmonitor
